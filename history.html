<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Track & Playback Kapal</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Font Awesome untuk ikon menu, play/pause, reset -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Mencegah scrollbar pada body */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
        }

        #main-container {
            display: flex; /* Menggunakan flexbox untuk tata letak utama */
            height: calc(100% - 60px); /* Total tinggi container setelah header */
            transition: margin-left 0.5s ease; /* Transisi untuk menggeser main-content */
        }

        .header {
            background: linear-gradient(to right, #005C97, #363795); color: white; padding: 1px 20px;
            display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); flex-shrink: 0;
            z-index: 1001;
            height: 40px; /* Tinggi header tetap seperti di index.html */
        }
        .header h1 { margin: 0; font-size: 1.5em; flex-grow: 1; text-align: center; } /* Ukuran font dan posisi di tengah */

        #menu-toggle-button {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.2s ease-in-out;
        }

        #menu-toggle-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        #ship-counter { 
            font-size: 1em; 
            background-color: rgba(255,255,255,0.2); 
            padding: 5px 10px; 
            border-radius: 15px; 
            cursor:pointer; 
            transition: background-color 0.2s;
        }
        #ship-counter:hover {
            background-color: rgba(255,255,255,0.3);
        }

        #map-container {
            flex-grow: 1; /* Peta mengisi sisa ruang */
            height: 100%;
            position: relative; /* Penting untuk Leaflet */
            transition: width 0.5s ease; /* Transisi lebar peta */
        }

        #map {
            height: 100%; /* Peta mengisi penuh container-nya */
            width: 100%;
        }

        #sidebar {
            width: 0; /* Awalnya tersembunyi */
            background-color: rgba(255, 255, 255, 0.95);
            overflow-x: hidden; /* Sembunyikan overflow horizontal */
            transition: width 0.5s ease; /* Transisi lebar sidebar */
            padding-top: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.15);
            flex-shrink: 0; /* Mencegah sidebar mengecil */
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #sidebar.open {
            width: 300px; /* Lebar sidebar saat terbuka */
        }

        #sidebar-menu {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 0; /* Hapus padding default */
        }

        .sidebar-menu-item {
            display: block;
            padding: 10px 15px;
            background-color: #f0f0f0;
            color: #333;
            text-decoration: none;
            border-radius: 5px;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
            text-align: center;
        }

        .sidebar-menu-item:hover {
            background-color: #e0e0e0;
            cursor: pointer;
        }
        
        #file-upload-section, #playback-controls-section, #settings-section {
            padding: 0 20px; /* Padding horizontal saja */
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            box-sizing: border-box;
        }

        /* Styling for section titles in sidebar */
        .sidebar-section-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
            padding: 0 20px; /* Padding agar sejajar dengan input */
        }
        
        #file-upload-section label, #playback-controls-section label, #settings-section label {
            font-size: 0.9em;
            margin-bottom: 6px;
            color: #555;
            font-weight: 600;
        }
        #file-upload-section input[type="file"] {
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background-color: #fdfdfd;
            font-size: 0.9em;
            color: #444;
            width: calc(100% - 18px);
            transition: border-color 0.2s ease-in-out;
        }
        #file-upload-section input[type="file"]:hover,
        #file-upload-section input[type="file"]:focus {
            border-color: #a7d9ff;
            outline: none;
        }
        #processButton {
            background-color: #007bff;
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            align-self: flex-end;
            margin-top: 10px;
        }
        #processButton:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }

        /* Playback Controls Specific Styles */
        #playback-controls-section button {
            background-color: #6c757d; /* Abu-abu default */
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
            margin-right: 5px; /* Spasi antar tombol */
        }
        #playback-controls-section button:hover {
            background-color: #5a6268;
        }
        #playback-controls-section #playPauseButton {
            background-color: #28a745; /* Hijau untuk Play */
        }
        #playback-controls-section #playPauseButton:hover {
            background-color: #218838;
        }
        #playback-controls-section #resetButton {
            background-color: #dc3545; /* Merah untuk Reset */
        }
        #playback-controls-section #resetButton:hover {
            background-color: #c82333;
        }

        /* Styling for new sliders */
        #playbackSpeedSlider, #playbackSeekSlider {
            width: 100%;
            -webkit-appearance: none; /* Override default look for Webkit browsers */
            appearance: none;
            height: 8px;
            background: #d3d3d3;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
            border-radius: 5px;
            margin-top: 5px;
            margin-bottom: 5px;
        }

        #playbackSpeedSlider:hover, #playbackSeekSlider:hover {
            opacity: 1;
        }

        #playbackSpeedSlider::-webkit-slider-thumb,
        #playbackSeekSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }

        #playbackSpeedSlider::-moz-range-thumb,
        #playbackSeekSlider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }

        #currentTimeDisplay {
            margin-top: 10px;
            font-size: 0.95em;
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
            background-color: #f0f0f0;
            padding: 8px;
            border-radius: 4px;
        }

        /* Settings section specific styles */
        #settings-section .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px; /* Spasi antara checkbox dan label */
            font-size: 0.9em;
            color: #555;
            font-weight: 400;
        }
        #settings-section .checkbox-group input[type="checkbox"] {
            margin: 0; /* Hapus margin default */
            transform: scale(1.2); /* Perbesar sedikit checkbox */
        }
        /* Style untuk checkbox yang disabled */
        #settings-section .checkbox-group.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        #settings-section .checkbox-group.disabled label {
            cursor: not-allowed;
        }
        #settings-section .checkbox-group.disabled input[type="checkbox"] {
            cursor: not-allowed;
        }


        /* Styles for ship markers (SVG-based) */
        /* Leaflet akan menambahkan .leaflet-marker-icon ke div yang berisi SVG ini */
        .ship-marker svg {
            /* Transform ini memusatkan SVG di dalam div yang dibuat Leaflet
               dan menerapkan rotasi. */
            transform-origin: center center; /* Pastikan rotasi di tengah SVG */
            display: block; /* Penting untuk transform */
            width: 100%; /* Pastikan SVG mengisi div ikon */
            height: 100%;
        }

        /* Warna fill untuk moving dan stationary akan langsung diatur di SVG HTML */

        /* Tab styles */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
            padding: 0 20px;
        }

        .tab-button {
            background-color: #f1f1f1;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 10px 15px;
            transition: 0.3s;
            font-size: 0.9em;
            color: #555;
            font-weight: 600;
            border-radius: 5px 5px 0 0;
            flex-grow: 1; /* Each tab takes equal width */
            text-align: center;
        }

        .tab-button:hover {
            background-color: #ddd;
        }

        .tab-button.active {
            background-color: #2c3e50;
            color: white;
            border-bottom: 3px solid #007bff;
            padding-bottom: 8px;
        }

        .tab-content {
            display: none; /* Hide all tab content by default */
            padding: 0 20px; /* Keep padding consistent */
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: flex; /* Show active tab content */
            flex-direction: column;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Styling for date input */
        .tab-content input[type="date"] {
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background-color: #fdfdfd;
            font-size: 0.9em;
            color: #444;
            width: calc(100% - 18px); /* Adjust for padding */
            transition: border-color 0.2s ease-in-out;
        }
        .tab-content input[type="date"]:hover,
        .tab-content input[type="date"]:focus {
            border-color: #a7d9ff;
            outline: none;
        }

        /* Message display area */
        #message-area {
            padding: 10px 20px;
            margin-top: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            font-size: 0.9em;
            display: none; /* Hidden by default */
        }
        #message-area.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        #message-area.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* CSS untuk highlight ikon kapal */
        .ship-marker-container .ship-icon.highlighted {
            filter: drop-shadow(0 0 4px rgba(255, 255, 0, 0.8)) drop-shadow(0 0 8px rgba(255, 255, 0, 0.6)); /* Yellow glow */
        }
        .ship-marker-container .ship-icon.highlighted path,
        .ship-marker-container .ship-icon.highlighted circle {
            stroke-width: 2.5 !important; /* Thicker outline */
            stroke: yellow !important;   /* Yellow outline */
        }

        /* Info Panel styles (copied from index.html) */
        #info-panel { 
            position: absolute; top: 63px; left: 60px; width: 340px; max-height: calc(100vh - 160px); 
            background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            z-index: 1000; overflow-y: auto; display: none; /* Default hidden */
        }
        .info-header { padding: 10px 15px; background-color: #f7f7f7; border-bottom: 1px solid #ddd; 
            display: flex; justify-content: space-between; align-items: center; cursor: move; }
        .info-header h3 { margin: 0; font-size: 1.1em; }
        .close-btn { cursor: pointer; font-size: 1.5em; font-weight: bold; color: #888; }
        .close-btn:hover { color: #333; }
        .info-details { padding: 15px; }

        .ship-info-table { width: 100%; font-family: Arial, sans-serif; border-collapse: collapse; font-size: 14px; background-color: #f9fafe; }
        .ship-info-table td { padding: 8px 12px; vertical-align: top; border-bottom: 1px solid #e0e0e0; }
        .ship-info-table td[colspan] { background-color: #f0f2f7; }
        .ship-info-table span.label { display: block; font-size: 12px; color: #555; margin-bottom: 4px; }
        .ship-info-table span.value { font-weight: bold; color: #000; display: flex; align-items: center; }
        .flex-row { display: flex; justify-content: space-between; gap: 16px; }
        .flex-row > div { flex: 1; }
        .fi { margin-right: 8px; font-size: 1.2em; }

        /* Status container styles (copied from index.html) */
        #status-container {
            position: relative;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 35px;
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            z-index: 1000;
            padding: 0 10px;
            gap: 10px;
            box-sizing: border-box;
        }
        .status-label {
            flex-shrink: 0;
            white-space: nowrap;
            font-weight: bold;
        }
        .status-slider {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            overflow: hidden;
        }
        .status-slide-item {
            position: absolute;
            width: 100%;
            white-space: nowrap;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            color: white;
            left: 0;
            text-align: left;
            padding-left: 10px;
            box-sizing: border-box;
            transition: transform 0.8s ease-in-out, opacity 0.8s ease-in-out;
        }
        #status-text-current {
            transform: translateY(0%);
            opacity: 1;
        }
        #status-text-next {
            transform: translateY(100%);
            opacity: 0;
        }
        .status-slide-item.leaving {
            transform: translateY(-100%);
            opacity: 0;
        }
        .status-slide-item.entering {
            transform: translateY(0%);
            opacity: 1;
        }
        .status-slide-item.hidden-below {
            transform: translateY(100%);
            opacity: 0;
        }
        .status-slide-item.hidden-above {
            transform: translateY(-100%);
            opacity: 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <button id="menu-toggle-button" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>
        <h1>AISMotion V2</h1>
        <div id="ship-counter" style="cursor:pointer;" title="Klik untuk menampilkan detail kapal terpilih">Kapal Aktif: 0</div>
    </div>

    <div id="main-container">
        <div id="sidebar">
            <div id="sidebar-menu">
                <a href="#" class="sidebar-menu-item" onclick="window.location.href='/';">Beranda</a>
            </div>
            <div class="sidebar-section-title">Unggah Data</div>
            
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('fileUploadTab')">Unggah File</button>
                <button class="tab-button" onclick="switchTab('dateSelectTab')">Pilih Tanggal</button>
            </div>

            <div id="fileUploadTab" class="tab-content active">
                <div>
                    <label for="trackJsonFile">Pilih File Track History (.json atau .log):</label>
                    <input type="file" id="trackJsonFile" accept=".json,.log">
                </div>
                <div>
                    <label for="shipsJsonFile">Pilih File JSON Database Kapal (Opsional):</label>
                    <input type="file" id="shipsJsonFile" accept=".json">
                </div>
                <button id="processUploadButton" onclick="processSelectedFiles()">Unggah & Tampilkan</button>
            </div>

            <div id="dateSelectTab" class="tab-content">
                <div>
                    <label for="trackDateInput">Pilih Tanggal Log:</label>
                    <input type="date" id="trackDateInput">
                </div>
                <button id="processDateButton" onclick="processSelectedDate()">Tampilkan Data</button>
            </div>

            <div id="message-area" role="alert"></div>

            <div class="sidebar-section-title">Kontrol Playback</div>
            <div id="playback-controls-section">
                <div id="playback-buttons">
                    <button id="playPauseButton" onclick="togglePlayPause()"><i class="fas fa-play"></i> Putar</button>
                    <button id="resetButton" onclick="resetPlayback()"><i class="fas fa-redo"></i> Reset</button>
                </div>
                <div>
                    <label for="playbackSpeedSlider">Kecepatan Playback: <span id="playbackSpeedValue">1x</span></label>
                    <input type="range" id="playbackSpeedSlider" min="0.5" max="100" step="0.5" value="1" oninput="setPlaybackSpeed(this.value)">
                </div>
                <div>
                    <label for="playbackSeekSlider">Waktu Playback:</label>
                    <input type="range" id="playbackSeekSlider" min="0" max="0" value="0" oninput="seekPlayback(this.value)">
                </div>
                <div id="currentTimeDisplay">
                    Waktu: Belum Dimulai
                </div>
            </div>

            <div class="sidebar-section-title">Pengaturan</div>
            <div id="settings-section">
                <div class="checkbox-group">
                    <input type="checkbox" id="showAllPolylines" onchange="handlePolylineVisibilityChange()">
                    <label for="showAllPolylines">Tampilkan Semua Polyline</label>
                </div>
                <div class="checkbox-group disabled" id="selectedPolylineCheckboxGroup">
                    <input type="checkbox" id="showSelectedShipPolylineOnly" disabled onchange="updatePolylineVisibility()">
                    <label for="showSelectedShipPolylineOnly">Hanya Tampilkan Polyline Kapal Terpilih</label>
                </div>
            </div>
        </div>

        <div id="map-container">
            <div id="map"></div>
        </div>
    </div>

    <!-- Panel informasi kapal (dari index.html) -->
    <div id="info-panel">
        <div class="info-header">
            <h3 id="info-ship-name">Detail Kapal</h3>
            <span class="close-btn" onclick="toggleInfoPanel(false)">&times;</span>
        </div>
        <div class="info-details" id="info-details-content"></div>
    </div>

    <!-- Status koneksi di bagian bawah (dari index.html) -->
    <div id="status-container" title="Klik untuk expand/collapse">
        <span class="status-label">Status Koneksi:</span>
        <div class="status-slider">
            <div id="status-text-current" class="status-slide-item">Memuat status...</div>
            <div id="status-text-next" class="status-slide-item"></div>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.vectorgrid/dist/Leaflet.VectorGrid.bundled.js"></script>
    <script>
        // Deklarasi Variabel Global (Dipindahkan ke sini)
        var map = L.map('map', {
            zoomControl: false // Mencegah munculnya kontrol zoom default
        }).setView([-4.073226, 122.7448634], 9); // Koordinat tengah default (sekitar Sulawesi Tenggara, Indonesia)

        // === Base Layers === 
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
        });

        const satellite = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: '© Google Satellite'
        });

        const terrain = L.tileLayer('https://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: '© Google Terrain'
        });

        const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 20,
            attribution: 'Tiles © Esri — Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, and the GIS User Community'
        });

        // === Overlay ENC Indonesia (Vector Tiles) === 
        const encIndonesia = L.vectorGrid.protobuf("http://202.150.138.45/chartApi/utt-mvt/styles/tiles/{z}/{x}/{y}.mvt", {
            maxNativeZoom: 17,
            vectorTileLayerStyles: {
                "utt-mvt": {
                    weight: 1,
                    color: "#3388ff",
                    fillColor: "#b3e5fc",
                    fillOpacity: 0.3,
                    opacity: 0.8
                },
                "depths": {
                    color: "#2196f3",
                    weight: 1,
                    fillColor: "#bbdefb",
                    fillOpacity: 0.2
                },
                "buoys": {
                    color: "#ffeb3b",
                    weight: 2,
                    radius: 4
                },
                "lights": {
                    color: "#ffffff",
                    weight: 2,
                    radius: 3
                },
                "wrecks": {
                    color: "#f44336",
                    weight: 2,
                    dashArray: "4, 4"
                },
                "land": {
                    fill: true,
                    fillColor: "#e0e0e0",
                    fillOpacity: 1,
                    color: "#9e9e9e",
                    weight: 0.5
                }
            },
            interactive: true,
            attribution: "ENC © Pushidrosal / BIG"
        });

        // === OpenSeaMap Overlay (opsional tambahan) === 
        const openSeaMap = L.tileLayer('https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png', {
            attribution: '© OpenSeaMap contributors'
        });

        // === Layer Track Kapal (akan dikelola secara internal) === 
        const shipTrackOverlay = L.layerGroup(); 

        // === Daftar Layer ===
        const baseMaps = {
            "OpenStreetMap": osm,
            "Google Satellite": satellite,
            "Google Terrain": terrain,
            "Esri World Imagery": esri
        };

        const overlayMaps = {
            "OpenSeaMap": openSeaMap // Hanya OpenSeaMap yang tersisa di overlay
        }; 

        // === Kontrol Layer === 
        map.addLayer(osm); // Default base layer
        const layerControl = L.control.layers(baseMaps, overlayMaps, { position: 'bottomleft' }).addTo(map);
        L.control.zoom({ position: 'bottomleft' }).addTo(map);


        var polylines = {}; 
        var shipDatabase = {}; 
        var selectedMMSIForPopup = null;
        
        let playbackInterval = null;
        let minTimestamp = Infinity;
        let maxTimestamp = -Infinity;
        let currentPlaybackTime = 0;
        let playbackSpeedMultiplier = 1;
        let activeMarkers = {};

        let statusMessagesQueue = [];
        let currentMessageIndex = 0;
        let currentStatusText = "";
        let isTransitioning = false;
        let waitingUpdate = false;
        let currentDisplayElementId = 'status-text-current';

        const SHIPS_DB_URL = '/api/ship_database'; 
        const LOGS_TRACKS_BASE_URL = '/api/daily_track_log/';

        let currentlyDisplayedMMSIs = new Set(); 

        const MOVING_SPEED_THRESHOLD_KNOTS = 0.5;
        const NAV_STATUS_MAP = { 0: "Under way using engine", 1: "At anchor", 2: "Not under command", 3: "Restricted manoeuverability", 4: "Constrained by draught", 5: "Moored", 6: "Aground", 7: "Engaged in Fishing", 8: "Under way sailing", 15: "Not defined" };
        const SHIP_TYPE_MAP = { 30: "Fishing", 31: "Towing", 32: "Towing", 35: "Military ops", 40: "High-speed craft", 50: "Pilot Vessel", 52: "Tug", 60: "Passenger", 70: "Cargo", 80: "Tanker", 90: "Other" };
        const countryCodeMap = {
            "INDONESIA": "id", "SINGAPORE": "sg", "MALAYSIA": "my", "PHILIPPINES": "ph",
            "VIETNAM": "vn", "THAILAND": "th", "CHINA": "cn", "JAPAN": "jp",
            "KOREA, REPUBLIC OF": "kr", "SOUTH KOREA": "kr", "TAIWAN": "tw", "AUSTRALIA": "au",
            "PANAMA": "pa", "LIBERIA": "lr", "UNITED KINGDOM": "gb", "USA": "us", "UNITED STATES": "us",
            "MALTA": "mt", "CYPRUS": "cy", "NETHERLANDS": "nl", "ST KITTS & NEVIS": "kn",
            "GERMANY": "de", "BELGIUM": "be", "FRANCE": "fr", "CANADA": "ca", "MEXICO": "mx",
            "BRITISH VIRGIN ISLANDS": "vg", "COOK ISLANDS": "ck", "KIRIBATI": "ki",
            "MARSHALL ISLANDS": "mh", "VANUATU": "vu", "SOUTH AFRICA": "za",
            "ANTIGUA AND BARBUDA": "ag", "HONG KONG": "hk"
        };
        // End Deklarasi Variabel Global

        // Fungsi-fungsi (Dipindahkan ke Global Scope)
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('message-area');
            messageArea.textContent = message;
            messageArea.className = 'message-area ' + type;
            messageArea.style.display = 'block';
            setTimeout(() => {
                messageArea.style.display = 'none';
            }, 5000);
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
            setTimeout(() => {
                map.invalidateSize();
            }, 500);
        }

        function switchTab(tabId) {
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            const correspondingTabButton = document.querySelector(`.tab-button[onclick*="switchTab('${tabId}')"]`);
            if (correspondingTabButton) {
                correspondingTabButton.classList.add('active');
            }
        }

        function readFileAsync(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => resolve(event.target.result);
                reader.onerror = (event) => reject(event.target.error);
                reader.readAsText(file);
            });
        }

        async function fetchFileFromUrl(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error(`File tidak ditemukan (${response.status} ${response.statusText}). Pastikan endpoint server benar: ${url}`);
                    } else if (response.status === 0) {
                        throw new Error(`Permintaan diblokir (CORS) atau terjadi masalah jaringan. Pastikan Anda menjalankan aplikasi dari server web dan file dapat diakses.`);
                    } else {
                        throw new Error(`Gagal memuat ${url}: ${response.status} ${response.statusText}`);
                    }
                }
                if (response.headers.get('Content-Type')?.includes('application/json') && response.status === 404) {
                     return JSON.stringify({});
                }
                return await response.text();
            } catch (error) {
                console.error('Error fetching file:', error);
                showMessage(`Gagal memuat data: ${error.message}`, 'error');
                return null;
            }
        }

        async function loadShipDatabase() {
            try {
                const shipsDataRaw = await fetchFileFromUrl(SHIPS_DB_URL);
                if (shipsDataRaw) {
                    shipDatabase = JSON.parse(shipsDataRaw);
                    console.log('Database Kapal berhasil dimuat otomatis dari API:', shipDatabase);
                } else {
                    shipDatabase = {};
                    showMessage('Database kapal tidak ditemukan atau gagal dimuat dari API /api/ship_database. Playback akan dilanjutkan tanpa info kapal.', 'info');
                }
            } catch (e) {
                shipDatabase = {};
                console.error('Error parsing database kapal otomatis dari API:', e);
                showMessage('Error parsing database kapal otomatis dari API. Pastikan format JSON benar di server.', 'error');
            }
        }

        async function processSelectedFiles() {
            const trackFileInput = document.getElementById('trackJsonFile');
            const shipsFileInput = document.getElementById('shipsJsonFile');
            const trackFile = trackFileInput.files[0];
            const shipsFile = shipsFileInput.files[0];

            if (!trackFile) {
                showMessage('Silakan pilih file Track History (.json atau .log) terlebih dahulu.', 'error');
                return;
            }
            if (shipsFile) {
                try {
                    const shipsData = await readFileAsync(shipsFile);
                    shipDatabase = JSON.parse(shipsData);
                    console.log('Database Kapal berhasil dimuat dari unggahan:', shipDatabase);
                } catch (e) {
                    showMessage('Error parsing file JSON Database Kapal yang diunggah: ' + e.message, 'error');
                    return;
                }
            } else {
                await loadShipDatabase();
            }
            try {
                const trackDataRaw = await readFileAsync(trackFile);
                await processTrackData(trackDataRaw, trackFile.name);
            } catch (e) {
                showMessage('Error memproses file Track History: ' + e.message, 'error');
                console.error('Error saat memproses file Track History:', e);
            }
        }

        async function processSelectedDate() {
            const trackDateInput = document.getElementById('trackDateInput');
            const selectedDate = trackDateInput.value;
            if (!selectedDate) {
                showMessage('Silakan pilih tanggal terlebih dahulu.', 'error');
                return;
            }
            const trackFileUrl = `${LOGS_TRACKS_BASE_URL}${selectedDate}.log`;
            await loadShipDatabase();
            try {
                const trackDataRaw = await fetchFileFromUrl(trackFileUrl);
                if (trackDataRaw) {
                    await processTrackData(trackDataRaw, trackFileUrl);
                } else {
                    showMessage(`Tidak ada data track ditemukan untuk tanggal ${selectedDate}.`, 'info');
                }
            } catch (e) {
                // showMessage sudah dipanggil di fetchFileFromUrl.
            }
        }

        async function processTrackData(trackDataRaw, fileName) {
            let parsedTrackData;
            const fileExtension = fileName.split('.').pop().toLowerCase(); 
            try {
                parsedTrackData = JSON.parse(trackDataRaw);
                console.log(`Data track dari ${fileName} berhasil di-parse sebagai JSON.`);
            } catch (jsonParseError) {
                throw new Error(`Gagal mem-parse data track dari ${fileName} sebagai JSON: ${jsonParseError.message}. Pastikan data yang dikembalikan oleh API adalah JSON yang valid.`);
            }
            displayTracks(parsedTrackData);

            minTimestamp = Infinity;
            maxTimestamp = -Infinity;
            let hasValidTrackData = false;
            for (const id in polylines) {
                if (polylines[id] && polylines[id].timestampsRaw) {
                    polylines[id].timestampsRaw.forEach(timestamp => {
                        if (timestamp < minTimestamp) minTimestamp = timestamp;
                        if (timestamp > maxTimestamp) maxTimestamp = timestamp;
                        hasValidTrackData = true;
                    });
                }
            }
            if (hasValidTrackData) {
                currentPlaybackTime = minTimestamp;
                const playbackSeekSlider = document.getElementById('playbackSeekSlider');
                playbackSeekSlider.min = minTimestamp;
                playbackSeekSlider.max = maxTimestamp;
                playbackSeekSlider.value = currentPlaybackTime;
                updateShipPositions();
                showMessage('Data track berhasil dimuat dan ditampilkan.', 'info');
            } else {
                minTimestamp = 0;
                maxTimestamp = 0;
                currentPlaybackTime = 0;
                const playbackSeekSlider = document.getElementById('playbackSeekSlider');
                playbackSeekSlider.min = 0;
                playbackSeekSlider.max = 0;
                playbackSeekSlider.value = 0;
                document.getElementById('currentTimeDisplay').textContent = "Waktu: Tidak Ada Data Track";
                showMessage('Tidak ada data track yang valid untuk ditampilkan.', 'info');
            }
            updatePolylineVisibility(); 
        }

        function displayTracks(data) {
            for (let id in polylines) {
                if (polylines[id]) {
                    polylines[id].removeFrom(map);
                }
            }
            polylines = {};
            for (const id in activeMarkers) {
                if (activeMarkers[id]) {
                    activeMarkers[id].removeFrom(map);
                }
            }
            activeMarkers = {};
            let bounds = new L.LatLngBounds();
            for (const id in data) {
                if (data.hasOwnProperty(id)) {
                    const trackPoints = data[id];
                    const latlngs = [];
                    const timestampsRaw = [];
                    const formattedDateTimes = [];
                    // Array untuk menyimpan kecepatan pada setiap titik
                    const speeds = [];

                    if (!Array.isArray(trackPoints)) {
                        console.warn(`Track ID ${id} bukan array atau kosong, dilewati.`);
                        continue; 
                    }
                    trackPoints.forEach((point, index) => {
                        if (Array.isArray(point) && point.length >= 3) {
                            const lat = point[0];
                            const lng = point[1];
                            const timestamp = point[2];
                            if (typeof lat === 'number' && typeof lng === 'number' && typeof timestamp === 'number' && !isNaN(lat) && !isNaN(lng) && !isNaN(timestamp)) {
                                latlngs.push([lat, lng]);
                                timestampsRaw.push(timestamp);
                                const date = new Date(timestamp * 1000);
                                const formattedDateTime = date.toLocaleString('id-ID', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' });
                                formattedDateTimes.push(formattedDateTime);
                                bounds.extend([lat, lng]);

                                // Hitung kecepatan untuk titik ini jika ada titik sebelumnya
                                if (index > 0) {
                                    const prevPoint = trackPoints[index - 1];
                                    const prevLat = prevPoint[0];
                                    const prevLng = prevPoint[1];
                                    const prevTimestamp = prevPoint[2];
                                    const speed = calculateSpeed(prevLat, prevLng, prevTimestamp, lat, lng, timestamp);
                                    speeds.push(speed);
                                } else {
                                    speeds.push(0); // Kecepatan 0 untuk titik pertama
                                }

                            } else {
                                console.warn(`Format titik data tidak valid untuk track ${id}:`, point);
                            }
                        } else {
                            console.warn(`Struktur titik tidak valid untuk track ${id}:`, point);
                        }
                    });
                    if (latlngs.length > 0) {
                        const polyline = L.polyline(latlngs, { color: getRandomColor(), weight: 3, opacity: 0.7 });
                        polylines[id] = polyline;
                        polyline.trackId = id;
                        polyline.latlngs = latlngs;
                        polyline.timestampsRaw = timestampsRaw;
                        polyline.formattedDateTimes = formattedDateTimes;
                        polyline.speeds = speeds; // Simpan kecepatan di objek polyline

                        // Tambahkan event listener untuk klik pada polyline
                        polyline.on('click', function(e) {
                            // Hapus tooltip sebelumnya jika ada
                            if (currentPolylineTooltip) {
                                map.removeLayer(currentPolylineTooltip);
                                currentPolylineTooltip = null;
                            }

                            // Temukan titik terdekat pada polyline
                            let minDistance = Infinity;
                            let closestIndex = -1;
                            for (let i = 0; i < polyline.latlngs.length; i++) {
                                const vertexLatLng = L.latLng(polyline.latlngs[i]);
                                const distance = e.latlng.distanceTo(vertexLatLng);
                                if (distance < minDistance) {
                                    minDistance = distance;
                                    closestIndex = i;
                                }
                            }

                            if (closestIndex !== -1) {
                                const clickedTimestamp = polyline.timestampsRaw[closestIndex];
                                const clickedFormattedTime = polyline.formattedDateTimes[closestIndex];

                                // Update playback time dan highlight
                                currentPlaybackTime = clickedTimestamp;
                                selectedMMSIForPopup = polyline.trackId; // Highlight marker dan polyline ini
                                updateShipPositions(); // Ini akan memicu updatePolylineVisibility

                                // Tampilkan tooltip dengan timestamp
                                currentPolylineTooltip = L.tooltip({
                                    permanent: false, // Akan hilang saat klik lain
                                    direction: 'right',
                                    offset: [10, 0]
                                })
                                .setLatLng(e.latlng)
                                .setContent(`Waktu: ${clickedFormattedTime}`)
                                .addTo(map);

                                // Atur event listener untuk menghapus tooltip jika diklik di tempat lain di peta
                                map.once('click', function() {
                                    if (currentPolylineTooltip) {
                                        map.removeLayer(currentPolylineTooltip);
                                        currentPolylineTooltip = null;
                                    }
                                });
                            }
                        });
                        
                        if (bounds.isValid()) {
                             map.fitBounds(bounds);
                        }
                    } else {
                        console.warn(`Track ID ${id} tidak memiliki titik yang valid untuk ditampilkan.`);
                    }
                }
            }
        }

        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        function togglePlayPause() {
            const playPauseBtn = document.getElementById('playPauseButton');
            if (playbackInterval) {
                clearInterval(playbackInterval);
                playbackInterval = null;
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i> Putar';
            } else {
                if (minTimestamp === Infinity || maxTimestamp === -Infinity || minTimestamp === maxTimestamp) {
                    showMessage("Tidak ada data track yang valid untuk playback.", 'info');
                    return;
                }
                if (currentPlaybackTime >= maxTimestamp) {
                    currentPlaybackTime = minTimestamp;
                }
                playbackInterval = setInterval(() => {
                    currentPlaybackTime += playbackSpeedMultiplier;
                    if (currentPlaybackTime > maxTimestamp) {
                        currentPlaybackTime = maxTimestamp;
                        clearInterval(playbackInterval);
                        playbackInterval = null;
                        playPauseBtn.innerHTML = '<i class="fas fa-play"></i> Putar';
                    }
                    updateShipPositions();
                }, 1000 / playbackSpeedMultiplier); 
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i> Jeda';
            }
        }

        function resetPlayback() {
            clearInterval(playbackInterval);
            playbackInterval = null;
            currentPlaybackTime = minTimestamp;
            document.getElementById('playPauseButton').innerHTML = '<i class="fas fa-redo"></i> Reset';
            document.getElementById('playbackSeekSlider').value = currentPlaybackTime;
            for (const id in activeMarkers) {
                if (activeMarkers[id]) {
                    activeMarkers[id].removeFrom(map);
                }
            }
            activeMarkers = {};
            updatePolylineVisibility(); 
            updateShipPositions();
        }

        function setPlaybackSpeed(speed) {
            playbackSpeedMultiplier = parseFloat(speed);
            document.getElementById('playbackSpeedValue').textContent = `${playbackSpeedMultiplier}x`;
            if (playbackInterval) {
                clearInterval(playbackInterval);
                playbackInterval = null;
                togglePlayPause();
            }
        }

        function seekPlayback(seekTime) {
            currentPlaybackTime = parseFloat(seekTime);
            updateShipPositions();
            updatePolylineVisibility();
        }
        
        function updateShipPositions() {
            const shouldSwap = false; 
            const playbackSeekSlider = document.getElementById('playbackSeekSlider');

            if (playbackSeekSlider && minTimestamp !== Infinity) { 
                playbackSeekSlider.value = currentPlaybackTime;
            }

            const markersToRemove = [];
            for (const id in activeMarkers) {
                const track = polylines[id];
                if (!track || (track.timestampsRaw && currentPlaybackTime > track.timestampsRaw[track.timestampsRaw.length - 1])) {
                    markersToRemove.push(id);
                }
            }
            markersToRemove.forEach(id => {
                if (activeMarkers[id]) {
                    activeMarkers[id].removeFrom(map);
                    delete activeMarkers[id];
                    currentlyDisplayedMMSIs.delete(parseInt(id));
                }
            });

            let activeShipCount = 0;

            for (const id in polylines) {
                const track = polylines[id];
                const shipStaticData = shipDatabase[id] || {}; 
                
                if (!track || !track.latlngs || !track.timestampsRaw || track.timestampsRaw.length === 0) {
                    if (activeMarkers[id]) {
                        activeMarkers[id].removeFrom(map);
                        delete activeMarkers[id];
                        currentlyDisplayedMMSIs.delete(parseInt(id));
                    }
                    continue; 
                }
                const { latlngs, timestampsRaw, formattedDateTimes, speeds } = track;

                let closestPointIndex = -1;
                for (let i = 0; i < timestampsRaw.length; i++) {
                    if (timestampsRaw[i] <= currentPlaybackTime) {
                        closestPointIndex = i;
                    } else {
                        break;
                    }
                }

                if (closestPointIndex !== -1) {
                    const currentLatLngArray = latlngs[closestPointIndex]; 
                    let markerLat = currentLatLngArray[0];
                    let markerLng = currentLatLngArray[1];

                    const markerPosition = L.latLng(markerLat, markerLng); 
                    const currentTimestamp = timestampsRaw[closestPointIndex];
                    
                    let isMoving = false;
                    let rotation = 0; 
                    let currentSpeed = 0; // Inisialisasi kecepatan
                    const movementThreshold = 0.5; 
                    
                    // Hitung kecepatan dan bearing hanya jika ada titik sebelumnya
                    if (closestPointIndex > 0) {
                        const prevPoint = latlngs[closestPointIndex - 1]; 
                        const prevTimestamp = timestampsRaw[closestPointIndex - 1];
                        
                        const distance = map.distance(L.latLng(prevPoint[0], prevPoint[1]), L.latLng(currentLatLngArray[0], currentLatLngArray[1]));
                        const timeDiff = currentTimestamp - prevTimestamp;

                        if (distance > movementThreshold && timeDiff > 0) { 
                            isMoving = true;
                            rotation = calculateBearing(prevPoint[0], prevPoint[1], currentLatLngArray[0], currentLatLngArray[1]);
                            currentSpeed = speeds[closestPointIndex]; // Ambil kecepatan yang sudah dihitung
                        }
                    } 
                    // Kasus khusus untuk titik pertama jika ada titik berikutnya
                    else if (latlngs.length > 1 && (closestPointIndex + 1) < latlngs.length) {
                        const nextPoint = latlngs[closestPointIndex + 1]; 
                        const nextTimestamp = timestampsRaw[closestPointIndex + 1];
                        
                        const distanceToNext = map.distance(L.latLng(currentLatLngArray[0], currentLatLngArray[1]), L.latLng(nextPoint[0], nextPoint[1]));
                        const timeDiffToNext = nextTimestamp - currentTimestamp;

                        if (timeDiffToNextSeconds > 0) {
                            const speedMps = distanceToNextMeters / timeDiffToNextSeconds;
                            currentSpeed = speedMps * 1.94384; // Konversi m/s ke knot
                            if (currentSpeed > MOVING_SPEED_THRESHOLD_KNOTS) {
                                isMoving = true;
                                rotation = calculateBearing(currentLatLngArray[0], currentLatLngArray[1], nextPoint[0], nextPoint[1]);
                            }
                        }
                    }
                    
                    const isHighlighted = (id === selectedMMSIForPopup);
                    const shipType = shipStaticData.ship_type_code;
                    const icon = L.divIcon({
                        className: 'ship-marker-container',
                        html: getShipIconHtml(id, isMoving, isHighlighted, shipType, rotation),
                        iconSize: isMoving ? [24, 24] : [24, 24],
                        iconAnchor: isMoving ? [12, 12] : [12, 12]
                    });

                    if (!activeMarkers[id]) {
                        activeMarkers[id] = L.marker(markerPosition, { icon: icon }).addTo(map);
                        activeMarkers[id].on('click', () => { 
                            toggleInfoPanel(true, id);
                        });
                    } else {
                        activeMarkers[id].setLatLng(markerPosition);
                        activeMarkers[id].setIcon(icon);
                    }
                    currentlyDisplayedMMSIs.add(parseInt(id));
                    activeShipCount++;

                    // Simpan data dinamis sementara ke objek track untuk updateInfoPanel
                    track.currentDynamicData = {
                        lat: currentLatLngArray[0],
                        lon: currentLatLngArray[1],
                        timestamp: currentTimestamp,
                        formattedTime: formattedDateTimes[closestPointIndex],
                        sog: currentSpeed, // Kecepatan yang dihitung
                        cog: rotation, // Arah yang dihitung
                        isMoving: isMoving
                    };

                } else { 
                    if (activeMarkers[id]) {
                        activeMarkers[id].removeFrom(map);
                        delete activeMarkers[id];
                        currentlyDisplayedMMSIs.delete(parseInt(id));
                    }
                }
            }
            document.getElementById('ship-counter').textContent = `Kapal Aktif: ${activeShipCount}`;
            
            const currentTimeDisplay = document.getElementById('currentTimeDisplay');
            if (currentTimeDisplay) {
                if (minTimestamp === Infinity) {
                     currentTimeDisplay.textContent = "Waktu: Tidak Ada Data Track";
                } else {
                    currentTimeDisplay.textContent = "Waktu: " + new Date(currentPlaybackTime * 1000).toLocaleString('id-ID', {
                        year: 'numeric', month: 'long', day: 'numeric',
                        hour: '2-digit', minute: '2-digit', second: '2-digit'
                    });
                }
            }
            updatePolylineVisibility();
            if (selectedMMSIForPopup && document.getElementById('info-panel').style.display !== 'none') {
                 // Kirim data dinamis yang relevan ke updateInfoPanel
                 const currentShipTrackData = polylines[selectedMMSIForPopup];
                 if (currentShipTrackData && currentShipTrackData.currentDynamicData) {
                    updateInfoPanel(currentShipTrackData.trackId, currentShipTrackData.currentDynamicData);
                 } else {
                    // Fallback jika data dinamis tidak tersedia (misal kapal baru saja hilang)
                    updateInfoPanel(selectedMMSIForPopup, {lat: null, lon: null, sog: null, cog: null, isMoving: false, timestamp: null, formattedTime: '—'});
                 }
            }
        }

        // Fungsi baru untuk menghitung kecepatan
        function calculateSpeed(lat1, lon1, time1, lat2, lon2, time2) {
            const distanceMeters = map.distance(L.latLng(lat1, lon1), L.latLng(lat2, lon2)); // Jarak dalam meter
            const timeDiffSeconds = time2 - time1; // Selisih waktu dalam detik

            if (timeDiffSeconds <= 0 || distanceMeters < 0.1) { // Jika selisih waktu nol atau jarak terlalu kecil
                return 0; // Kecepatan nol
            }

            const speedMetersPerSecond = distanceMeters / timeDiffSeconds;
            const speedKnots = speedMetersPerSecond * 1.94384; // Konversi m/s ke knot

            return parseFloat(speedKnots.toFixed(2)); // Bulatkan ke 2 desimal
        }

        function getCountryCode(countryName) {
            if (!countryName) return 'xx';
            const upperCountryName = String(countryName).toUpperCase();
            return countryCodeMap[upperCountryName] || 'xx';
        }
        function formatValue(value, unit = '') { 
            const unavailableValues = [null, undefined, '']; 
            // Memformat angka menjadi 2 desimal jika itu angka dan bukan nilai unavailable
            if (typeof value === 'number' && !isNaN(value) && !unavailableValues.includes(value)) {
                return `${value.toFixed(2)} ${unit}`.trim();
            }
            if (unavailableValues.includes(value)) return '—'; 
            return `${value} ${unit}`.trim(); 
        }
        function getShipTypeString(code) { if (!code) return '—'; if (code >= 70 && code <= 79) return SHIP_TYPE_MAP[70]; if (code >= 60 && code <= 69) return SHIP_TYPE_MAP[60]; if (code >= 80 && code <= 89) return SHIP_TYPE_MAP[80]; return SHIP_TYPE_MAP[code] || `Other (${code})`; }
        function formatETA(ship) { if (ship.eta_month && ship.eta_day && ship.eta_hour !== null && ship.eta_minute !== null) { const day = String(ship.eta_day).padStart(2, '0'); const month = String(ship.eta_month).padStart(2, '0'); const hour = String(ship.eta_hour).padStart(2, '0'); const minute = String(ship.eta_minute).padStart(2, '0'); const year = new Date().getFullYear(); return `${day}/${month}/${year} ${hour}:${minute}`; } return '—'; }
        function formatLastSignal(timestamp) {
            if (!timestamp) return '—';
            const now = Date.now() / 1000;
            let diff = Math.floor(now - timestamp);
            if (diff < 60) { return `${diff}s lalu`; }
            const days = Math.floor(diff / 86400); diff %= 86400; const hours = Math.floor(diff / 3600); diff %= 3600; const minutes = Math.floor(diff / 60); const seconds = diff % 60;
            let parts = [];
            if (days > 0) parts.push(`${days}d`); if (hours > 0) parts.push(`${hours}h`); if (minutes > 0) parts.push(`${minutes}m`); if (seconds > 0) parts.push(`${seconds}s`);
            return parts.join(' ') + ' lalu';
        }

        function decimalToDMS(decimal, isLat) { if (decimal === null || decimal === undefined) return '—'; const dir = isLat ? (decimal >= 0 ? 'N' : 'S') : (decimal >= 0 ? 'E' : 'W'); const absDecimal = Math.abs(decimal); const degrees = Math.floor(absDecimal); const minutesNotTruncated = (absDecimal - degrees) * 60; const minutes = Math.floor(minutesNotTruncated); const seconds = ((minutesNotTruncated - minutes) * 60).toFixed(2); return `${degrees}° ${minutes}' ${seconds}" ${dir}`; }

        function toggleInfoPanel(show, mmsi = null) {
            const panel = document.getElementById('info-panel');
            if (show && mmsi) {
                selectedMMSIForPopup = mmsi;
                panel.style.display = 'block';
                // Panggil updateInfoPanel dengan data yang sudah di-update dari updateShipPositions
                const currentShipTrackData = polylines[mmsi];
                if (currentShipTrackData && currentShipTrackData.currentDynamicData) {
                    updateInfoPanel(currentShipTrackData.trackId, currentShipTrackData.currentDynamicData);
                } else {
                    // Fallback jika tidak ada data dinamis saat panel dibuka
                    updateInfoPanel(mmsi, {lat: null, lon: null, sog: null, cog: null, isMoving: false, timestamp: null, formattedTime: '—'});
                }
            } else {
                selectedMMSIForPopup = null;
                panel.style.display = 'none';
            }
            updateShipPositions(); // Panggil updateShipPositions untuk merefresh tampilan dan highlight
        }

        function makeDraggable(elmnt) { 
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0; 
            const dragHandle = elmnt.querySelector(".info-header"); 
            if (dragHandle) { 
                dragHandle.onmousedown = dragMouseDown; 
            } else { 
                elmnt.onmousedown = dragMouseDown; 
            } 
            function dragMouseDown(e) { 
                e = e || window.event; 
                if (e.target.classList.contains('close-btn')) return; 
                e.preventDefault(); 
                pos3 = e.clientX; 
                pos4 = e.clientY; 
                document.onmouseup = closeDragElement; 
                document.onmousemove = elementDrag; 
            } 
            function elementDrag(e) { 
                e = e || window.event; 
                e.preventDefault(); 
                pos1 = pos3 - e.clientX; 
                pos2 = pos4 - e.clientY; 
                pos3 = e.clientX; 
                pos4 = e.clientY; 
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px"; 
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px"; 
                elmnt.style.right = 'auto'; 
            } 
            function closeDragElement() { 
                document.onmouseup = null; 
                document.onmousemove = null; 
            } 
        }

        function updateInfoPanel(mmsi) {
            const shipStaticData = shipDatabase[mmsi]; 
            if (!shipStaticData) {
                toggleInfoPanel(false);
                return;
            }
            const shipName = shipStaticData.shipname || mmsi;
            const dimensionStr = (shipStaticData.length && shipStaticData.beam) ? `${shipStaticData.length}m x ${shipStaticData.beam}m` : '—';
            const countryCode = getCountryCode(shipStaticData.country);
            document.getElementById('info-ship-name').innerText = shipName;

            // Ambil data dinamis dari objek track yang disimpan di updateShipPositions
            const currentShipTrackData = polylines[mmsi];
            const dynamicData = currentShipTrackData ? currentShipTrackData.currentDynamicData : {};

            const currentShipLat = decimalToDMS(dynamicData.lat, true);
            const currentShipLon = decimalToDMS(dynamicData.lon, false);
            const currentShipTime = dynamicData.formattedTime;
            // Kecepatan ditampilkan dalam knot, dan '—' jika kapal diam (isMoving false)
            const displaySog = dynamicData.isMoving && dynamicData.sog !== null ? formatValue(dynamicData.sog, 'knot') : '—';
            const displayCog = dynamicData.isMoving && dynamicData.cog !== null ? formatValue(dynamicData.cog, '°') : '—';


            const content = `<table class="ship-info-table">
                <tr>
                    <td><span class="label">MMSI</span><span class="value">${formatValue(shipStaticData.mmsi)}</span></td>
                    <td><span class="label">Call Sign</span><span class="value">${formatValue(shipStaticData.callsign)}</span></td>
                    <td><span class="label">IMO</span><span class="value">${formatValue(shipStaticData.imo)}</span></td>
                </tr>
                <tr>
                    <td colspan="3"><div class="flex-row">
                        <div><span class="label">Status Navigasi</span><span class="value">${NAV_STATUS_MAP[shipStaticData.navigation_status] || '—'}</span></div>
                        <div><span class="label">Tipe Kapal</span><span class="value">${getShipTypeString(shipStaticData.ship_type_code)}</span></div>
                    </div></td>
                </tr>
                <tr>
                    <td colspan="3">
                        <div class="flex-row">
                            <div>
                                <span class="label">Bendera</span>
                                <span class="value">
                                    <span class="fi fi-${countryCode}"></span>
                                    ${formatValue(shipStaticData.country)}
                                </span>
                            </div>
                            <div>
                                <span class="label">Kelas</span>
                                <span class="value">${formatValue(shipStaticData.class || '—')}</span>
                            </div>
                            <div>
                                <span class="label">Tipe Pesan</span>
                                <span class="value">${formatValue(shipStaticData.message_type || '—')}</span>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td colspan="3"><div class="flex-row">
                        <div><span class="label">Latitude</span><span class="value">${currentShipLat}</span></div>
                        <div><span class="label">Longitude</span><span class="value">${currentShipLon}</span></div>
                    </div></td>
                </tr>
                <tr>
                    <td><span class="label">Kecepatan</span><span class="value">${displaySog}</span></td>
                    <td><span class="label">Arah (COG)</span><span class="value">${displayCog}</span></td>
                    <td><span class="label">Haluan (HDG)</span><span class="value">${formatValue(shipStaticData.true_heading || '—', '°')}</span></td>
                </tr>
                <tr>
                    <td colspan="3"><div class="flex-row">
                        <div><span class="label">Dimensi (PxL)</span><span class="value">${dimensionStr}</span></div>
                        <div><span class="label">Sarat Air</span><span class="value">${formatValue(shipStaticData.draught, 'm')}</span></div>
                    </div></td>
                </tr>
                <tr>
                    <td colspan="3"><div class="flex-row">
                        <div><span class="label">Tujuan</span><span class="value">${formatValue(shipStaticData.destination)}</span></div>
                        <div><span class="label">ETA</span><span class="value">${formatETA(shipStaticData)}</span></div>
                    </div></td>
                </tr>
                <tr>
                    <td colspan="3"><div class="flex-row">
                        <div><span class="label">Sumber</span><span class="value">${formatValue(shipStaticData.source_company || '—')}</span></div>
                        <div><span class="label">Waktu Posisi</span><span class="value">${currentShipTime}</span></div>
                    </div></td>
                </tr>
            </table>`;
            document.getElementById('info-details-content').innerHTML = content;
        }

        // Fungsi pembantu untuk menghitung bearing antara dua titik (dalam derajat)
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const toRad = (deg) => deg * Math.PI / 180;
            const toDeg = (rad) => rad * 180 / Math.PI;
            const φ1 = toRad(lat1);
            const φ2 = toRad(lat2);
            const Δλ = toRad(lon2 - lon1);
            const y = Math.sin(Δλ) * Math.cos(φ2);
            const x = Math.cos(φ1) * Math.sin(φ2) - Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
            const θ = Math.atan2(y, x);
            return (toDeg(θ) + 360) % 360;
        }

        // Event listener untuk memastikan peta memperbarui ukuran setelah jendela diubah ukurannya
        window.addEventListener('resize', function() {
            map.invalidateSize();
        });

        // DOMContentLoaded Listener (hanya berisi panggilan inisialisasi)
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('trackDateInput').value = `${year}-${month}-${day}`;

            switchTab('fileUploadTab');
            updatePolylineVisibility(); 
            makeDraggable(document.getElementById('info-panel'));

            // Memanggil updateConnectionStatus untuk pertama kali dan set interval
            updateConnectionStatus(); 
            setInterval(updateConnectionStatus, 5000);
        });
    </script>
</body>
</html>
